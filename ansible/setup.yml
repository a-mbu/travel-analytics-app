---
# Travel Analytics - WORKING ANSIBLE PLAYBOOK
# Run: ansible-playbook ansible/setup.yml --check (dry run)
# Run: ansible-playbook ansible/setup.yml (actual execution)

- name: Setup Travel Analytics Development Environment
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    project_dir: "{{ playbook_dir }}/.."
    python_version: "3.11"
    venv_path: "{{ ansible_env.HOME }}/.virtualenvs/travel-analytics"
    app_port: 5000

  tasks:
    - name: Display system information
      debug:
        msg:
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Architecture: {{ ansible_architecture }}"
          - "Project directory: {{ project_dir }}"

    - name: Check Python version
      command: python3 --version
      register: python_version_output
      changed_when: false
      ignore_errors: yes

    - name: Display Python version
      debug:
        msg: "{{ python_version_output.stdout }}"
      when: python_version_output is succeeded

    - name: Install system dependencies (Linux)
      become: yes
      package:
        name:
          - git
          - curl
          - python3-pip
          - python3-venv
          - sqlite3
        state: present
      when: ansible_system == "Linux"

    - name: Create virtual environment
      pip:
        name:
          - pip
          - setuptools
          - wheel
        virtualenv: "{{ venv_path }}"
        virtualenv_python: python3
      register: venv_created

    - name: Install Python requirements
      pip:
        requirements: "{{ project_dir }}/requirements.txt"
        virtualenv: "{{ venv_path }}"

    - name: Create .env file
      copy:
        dest: "{{ project_dir }}/.env"
        content: |
          FLASK_APP=app.py
          FLASK_ENV=development
          DATABASE_URL=sqlite:///{{ project_dir }}/travel.db
          PORT={{ app_port }}
        mode: "0644"

    - name: Initialize database
      shell: |
        source {{ venv_path }}/bin/activate
        python {{ project_dir }}/app.py
      args:
        executable: /bin/bash
      register: db_init
      failed_when: false
      changed_when: false

    - name: Check if application runs
      shell: |
        source {{ venv_path }}/bin/activate
        python {{ project_dir }}/app.py &
        sleep 3
        curl -f http://localhost:{{ app_port }}/api/v1/health
        kill %1 || true
      args:
        executable: /bin/bash
      register: app_test
      failed_when: false
      ignore_errors: yes

    - name: Display application status
      debug:
        msg:
          - "‚úÖ Development environment configured"
          - "üìÅ Project: {{ project_dir }}"
          - "üêç Virtual env: {{ venv_path }}"
          - "üöÄ Run: python {{ project_dir }}/app.py"
      when: app_test is succeeded

    - name: Display warning
      debug:
        msg: "‚ö†Ô∏è  Application test failed - check dependencies"
      when: app_test is failed

    - name: Summary
      debug:
        msg: "‚úÖ Ansible setup complete! Run 'python app.py' to start the server"
